#!/usr/bin/env bash
set -Eeuo pipefail

# ---------- é”™è¯¯å¤„ç† ----------
trap 'echo -e "\nâŒ è„šæœ¬æ‰§è¡Œå‡ºé”™ï¼ˆè¡Œ: $LINENOï¼‰ã€‚é€€å‡ºã€‚"; exit 1' ERR

# ---------- é…ç½®ä¸é»˜è®¤å€¼ ----------
# æƒé™çº§åˆ«ï¼šä¸å†åšå£ä»¤éªŒè¯ï¼Œç›´æ¥é»˜è®¤ fullï¼ˆå¯å¤–éƒ¨è¦†ç›–ï¼‰
export GENSYN_PERMISSION="${GENSYN_PERMISSION:-full}"

# è·³è¿‡ /etc/hosts å†™å…¥ï¼ˆé¿å… macOS è¦æ±‚ sudo å¯†ç ï¼‰
# æƒ³æ¢å¤è¯¥åŠŸèƒ½ï¼šæ‰§è¡Œå‰è®¾ SKIP_HOSTS_PATCH=0
SKIP_HOSTS_PATCH="${SKIP_HOSTS_PATCH:-1}"

echo "ğŸš€ Starting one-click RL-Swarm environment deployment (no auth)..."

# ---------- æ“ä½œç³»ç»Ÿæ£€æµ‹ ----------
OS_TYPE="unknown"
if [[ "$(uname -s)" == "Darwin" ]]; then
  OS_TYPE="macos"
elif [[ -f /etc/os-release ]]; then
  . /etc/os-release
  if [[ "${ID:-}" == "ubuntu" ]]; then
    OS_TYPE="ubuntu"
  fi
fi

if [[ "$OS_TYPE" == "unknown" ]]; then
  echo "âŒ ä¸æ”¯æŒçš„æ“ä½œç³»ç»Ÿã€‚ä»…æ”¯æŒ macOS å’Œ Ubuntuã€‚"
  exit 1
fi

# ---------- å…¬å…±å°å‡½æ•° ----------
require_cmd() {
  if ! command -v "$1" &>/dev/null; then
    echo "âŒ ç¼ºå°‘å‘½ä»¤ï¼š$1"
    return 1
  fi
}

append_zshrc_once() {
  local LINE="$1"
  local FILE="$HOME/.zshrc"
  grep -Fqx "$LINE" "$FILE" 2>/dev/null || echo "$LINE" >> "$FILE"
}

# ---------- /etc/hosts Patchï¼ˆé»˜è®¤è·³è¿‡ï¼Œé˜²æ­¢ sudo å¯†ç æç¤ºï¼‰ ----------
if [[ "$SKIP_HOSTS_PATCH" == "1" ]]; then
  echo "ğŸ”§ Skipping /etc/hosts patch (è®¾ç½® SKIP_HOSTS_PATCH=0 å¯å¯ç”¨)"
else
  echo "ğŸ”§ Checking /etc/hosts configuration..."
  if ! grep -q "raw.githubusercontent.com" /etc/hosts; then
    echo "ğŸ“ Writing GitHub accelerated Hosts entries..."
    # æ³¨æ„ï¼šè¿™é‡Œéœ€è¦ sudoï¼Œä¼šè¦æ±‚ç³»ç»Ÿå¯†ç 
    sudo tee -a /etc/hosts > /dev/null <<EOL
199.232.68.133 raw.githubusercontent.com
199.232.68.133 user-images.githubusercontent.com
199.232.68.133 avatars2.githubusercontent.com
199.232.68.133 avatars1.githubusercontent.com
EOL
  else
    echo "âœ… Hosts are already configured."
  fi
fi

# ---------- å®‰è£…ä¾èµ– ----------
if [[ "$OS_TYPE" == "macos" ]]; then
  echo "ğŸº Checking Homebrew..."
  if ! command -v brew &>/dev/null; then
    echo "ğŸ“¥ Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  else
    echo "âœ… Homebrew å·²å®‰è£…ï¼Œè·³è¿‡å®‰è£…ã€‚"
  fi

  # é…ç½® Brew ç¯å¢ƒå˜é‡
  BREW_ENV='eval "$(/opt/homebrew/bin/brew shellenv)"'
  append_zshrc_once "$BREW_ENV"
  eval "$(/opt/homebrew/bin/brew shellenv)"

  # å®‰è£…ä¾èµ–ï¼ˆè¡¥é½ go å’Œ jqï¼Œä¾¿äº p2pd å®‰è£…ï¼‰
  echo "ğŸ“¦ æ£€æŸ¥å¹¶å®‰è£… Node.js, Python@3.10, curl, screen, git, yarn, go, jq..."
  deps=(node python3.10 curl screen git yarn go jq)
  brew_names=(node python@3.10 curl screen git yarn go jq)
  for i in "${!deps[@]}"; do
    dep="${deps[$i]}"
    brew_name="${brew_names[$i]}"
    if ! command -v "$dep" &>/dev/null; then
      echo "ğŸ“¥ brew install $brew_name ..."
      # é‡è¯•å®‰è£…ï¼Œé¿å…å¶å‘ç½‘ç»œå¤±è´¥
      until brew install "$brew_name"; do
        echo "âš ï¸ $brew_name å®‰è£…å¤±è´¥ï¼Œ3ç§’åé‡è¯•..."
        sleep 3
      done
      echo "âœ… $brew_name å®‰è£…æˆåŠŸã€‚"
    else
      echo "âœ… $dep å·²å®‰è£…ï¼Œè·³è¿‡å®‰è£…ã€‚"
    fi
  done

  # æ¸…ç†æ—§ python3.12 é…ç½®ï¼Œå†™å…¥ 3.10 aliasï¼ˆä¸åŸé€»è¾‘ä¿æŒï¼‰
  if grep -q "# Python3.12 Environment Setup" ~/.zshrc 2>/dev/null; then
    echo "ğŸ§¹ æ¸…ç†æ—§çš„ Python3.12 é…ç½®..."
    sed -i '' '/# Python3.12 Environment Setup/,/^fi$/d' ~/.zshrc
  fi
  PYTHON_ALIAS="# Python3.10 Environment Setup"
  if ! grep -q "$PYTHON_ALIAS" ~/.zshrc 2>/dev/null; then
    cat << 'EOF' >> ~/.zshrc

# Python3.10 Environment Setup
if [[ $- == *i* ]]; then
  alias python="/opt/homebrew/bin/python3.10"
  alias python3="/opt/homebrew/bin/python3.10"
  alias pip="/opt/homebrew/bin/pip3.10"
  alias pip3="/opt/homebrew/bin/pip3.10"
fi
EOF
  fi
  # è®©å½“å‰ä¼šè¯å°½å¯èƒ½æ„ŸçŸ¥æœ€æ–° PATH
  # shellcheck disable=SC1090
  source ~/.zshrc || true

else
  # ---------- Ubuntu ----------
  echo "ğŸ“¦ æ£€æŸ¥å¹¶å®‰è£… Node.js (æœ€æ–°LTS), Python3, curl, screen, git, yarn, jq..."
  if command -v node &>/dev/null; then
    CURRENT_NODE_VERSION="$(node --version 2>/dev/null | sed 's/v//')"
    echo "ğŸ” å½“å‰ Node.js ç‰ˆæœ¬: $CURRENT_NODE_VERSION"
    LATEST_LTS_VERSION="$(curl -fsSL https://nodejs.org/dist/index.json | jq -r '.[0].version' 2>/dev/null | sed 's/v//')"
    echo "ğŸ” æœ€æ–° LTS ç‰ˆæœ¬: $LATEST_LTS_VERSION"
    if [[ "${CURRENT_NODE_VERSION:-}" != "${LATEST_LTS_VERSION:-}" && -n "${LATEST_LTS_VERSION:-}" ]]; then
      echo "ğŸ”„ æ›´æ–°åˆ°æœ€æ–° LTS ç‰ˆæœ¬..."
      sudo apt remove -y nodejs npm || true
      sudo apt autoremove -y || true
      sudo rm -rf /usr/local/bin/npm /usr/local/bin/node || true
      sudo rm -rf ~/.npm || true
      curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash -
      sudo apt-get install -y nodejs
      echo "âœ… Node.js å·²æ›´æ–°è‡³ LTS"
    else
      echo "âœ… Node.js å·²æ˜¯æœ€æ–° LTS æˆ–æ— æ³•åˆ¤å®šï¼Œè·³è¿‡æ›´æ–°"
    fi
  else
    echo "ğŸ“¥ å®‰è£… Node.js LTS..."
    curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash -
    sudo apt-get install -y nodejs
    echo "âœ… Node.js å®‰è£…å®Œæˆ"
  fi

  sudo apt update
  sudo apt install -y python3 python3-venv python3-pip curl screen git gnupg jq

  # Yarn å®‰è£…ï¼ˆå®˜æ–¹æºä¼˜å…ˆï¼‰
  if curl -fsS https://dl.yarnpkg.com/debian/pubkey.gpg | gpg --dearmor | sudo tee /usr/share/keyrings/yarnkey.gpg >/dev/null \
     && echo "deb [signed-by=/usr/share/keyrings/yarnkey.gpg] https://dl.yarnpkg.com/debian/ stable main" | sudo tee /etc/apt/sources.list.d/yarn.list >/dev/null; then
    sudo apt update && sudo apt install -y yarn
    yarn set version stable || true
    yarn -v || true
  else
    echo "âš ï¸ å®˜æ–¹æºå®‰è£… yarn å¤±è´¥ï¼Œå°è¯• npm å®‰è£…..."
    if ! command -v npm &>/dev/null; then
      sudo apt install -y npm
    fi
    npm config set registry https://registry.npmmirror.com
    npm install -g yarn
    yarn set version stable || true
    yarn -v || true
  fi

  # å†™å…¥ python aliasï¼ˆä¸åŸé€»è¾‘ä¿æŒï¼‰
  PYTHON_ALIAS="# Python3.12 Environment Setup"
  if ! grep -q "$PYTHON_ALIAS" ~/.bashrc 2>/dev/null; then
    cat << 'EOF' >> ~/.bashrc

# Python3.12 Environment Setup
if [[ $- == *i* ]]; then
  alias python="/usr/bin/python3"
  alias python3="/usr/bin/python3"
  alias pip="/usr/bin/pip3"
  alias pip3="/usr/bin/pip3"
fi
EOF
  fi
  # shellcheck disable=SC1090
  source ~/.bashrc || true
fi

# ---------- å®‰è£…/æ ¡éªŒ p2pdï¼ˆHivemind DHT éœ€è¦ï¼‰ ----------
ensure_p2pd() {
  if command -v p2pd &>/dev/null; then
    echo "âœ… p2pd å·²å®‰è£…ï¼š$(command -v p2pd)"
    return 0
  fi
  echo "ğŸ“¥ å®‰è£… p2pd (go-libp2p-daemon)..."
  # éœ€è¦ go
  if ! command -v go &>/dev/null; then
    if [[ "$OS_TYPE" == "macos" ]]; then
      echo "ğŸ“¥ é€šè¿‡ Homebrew å®‰è£… go ..."
      brew install go
    else
      echo "ğŸ“¥ é€šè¿‡ apt å®‰è£… golang ..."
      sudo apt update && sudo apt install -y golang-go
    fi
  fi
  mkdir -p "$HOME/.local/bin"
  GOBIN="$HOME/.local/bin" go install github.com/libp2p/go-libp2p-daemon@latest
  # åŠ  PATH
  if [[ ":$PATH:" != *":$HOME/.local/bin:"* ]]; then
    if [[ "$OS_TYPE" == "macos" ]]; then
      append_zshrc_once 'export PATH="$HOME/.local/bin:$PATH"'
      export PATH="$HOME/.local/bin:$PATH"
    else
      if ! grep -Fqx 'export PATH="$HOME/.local/bin:$PATH"' ~/.bashrc 2>/dev/null; then
        echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.bashrc
      fi
      export PATH="$HOME/.local/bin:$PATH"
    fi
  fi
  require_cmd p2pd
  echo "âœ… p2pd å®‰è£…å®Œæˆï¼š$(command -v p2pd)"
}
ensure_p2pd

# ---------- å…‹éš†å‰å¤‡ä»½å…³é”®æ–‡ä»¶ ----------
TMP_USER_FILES="$HOME/rl-swarm-user-files"
mkdir -p "$TMP_USER_FILES"

# swarm.pem
if [ -f "$HOME/rl-swarm-0.5.3/swarm.pem" ]; then
  cp "$HOME/rl-swarm-0.5.3/swarm.pem" "$TMP_USER_FILES/swarm.pem" && echo "âœ… å·²å¤‡ä»½ rl-swarm-0.5.3/swarm.pem"
elif [ -f "$HOME/rl-swarm-0.5.3/user/keys/swarm.pem" ]; then
  cp "$HOME/rl-swarm-0.5.3/user/keys/swarm.pem" "$TMP_USER_FILES/swarm.pem" && echo "âœ… å·²å¤‡ä»½ rl-swarm-0.5.3/user/keys/swarm.pem"
elif [ -f "$HOME/rl-swarm-0.5/user/keys/swarm.pem" ]; then
  cp "$HOME/rl-swarm-0.5/user/keys/swarm.pem" "$TMP_USER_FILES/swarm.pem" && echo "âœ… å·²å¤‡ä»½ 0.5/user/keys/swarm.pem"
elif [ -f "$HOME/rl-swarm/swarm.pem" ]; then
  cp "$HOME/rl-swarm/swarm.pem" "$TMP_USER_FILES/swarm.pem" && echo "âœ… å·²å¤‡ä»½ rl-swarm/swarm.pem"
else
  echo "âš ï¸ æœªæ£€æµ‹åˆ° swarm.pemï¼Œå¦‚æœ‰éœ€è¦è¯·æ‰‹åŠ¨è¡¥é½ã€‚"
fi

# userApiKey.json
if [ -f "$HOME/rl-swarm-0.5.3/modal-login/temp-data/userApiKey.json" ]; then
  cp "$HOME/rl-swarm-0.5.3/modal-login/temp-data/userApiKey.json" "$TMP_USER_FILES/userApiKey.json" && echo "âœ… å·²å¤‡ä»½ rl-swarm-0.5.3/modal-login/temp-data/userApiKey.json"
elif [ -f "$HOME/rl-swarm-0.5.3/user/modal-login/userApiKey.json" ]; then
  cp "$HOME/rl-swarm-0.5.3/user/modal-login/userApiKey.json" "$TMP_USER_FILES/userApiKey.json" && echo "âœ… å·²å¤‡ä»½ rl-swarm-0.5.3/user/modal-login/userApiKey.json"
elif [ -f "$HOME/rl-swarm-0.5/user/modal-login/userApiKey.json" ]; then
  cp "$HOME/rl-swarm-0.5/user/modal-login/userApiKey.json" "$TMP_USER_FILES/userApiKey.json" && echo "âœ… å·²å¤‡ä»½ 0.5/user/modal-login/userApiKey.json"
elif [ -f "$HOME/rl-swarm/modal-login/temp-data/userApiKey.json" ]; then
  cp "$HOME/rl-swarm/modal-login/temp-data/userApiKey.json" "$TMP_USER_FILES/userApiKey.json" && echo "âœ… å·²å¤‡ä»½ rl-swarm/modal-login/temp-data/userApiKey.json"
else
  echo "âš ï¸ æœªæ£€æµ‹åˆ° userApiKey.jsonï¼Œå¦‚æœ‰éœ€è¦è¯·æ‰‹åŠ¨è¡¥é½ã€‚"
fi

# userData.json
if [ -f "$HOME/rl-swarm-0.5.3/modal-login/temp-data/userData.json" ]; then
  cp "$HOME/rl-swarm-0.5.3/modal-login/temp-data/userData.json" "$TMP_USER_FILES/userData.json" && echo "âœ… å·²å¤‡ä»½ rl-swarm-0.5.3/modal-login/temp-data/userData.json"
elif [ -f "$HOME/rl-swarm-0.5.3/user/modal-login/userData.json" ]; then
  cp "$HOME/rl-swarm-0.5.3/user/modal-login/userData.json" "$TMP_USER_FILES/userData.json" && echo "âœ… å·²å¤‡ä»½ rl-swarm-0.5.3/user/modal-login/userData.json"
elif [ -f "$HOME/rl-swarm-0.5/user/modal-login/userData.json" ]; then
  cp "$HOME/rl-swarm-0.5/user/modal-login/userData.json" "$TMP_USER_FILES/userData.json" && echo "âœ… å·²å¤‡ä»½ 0.5/user/modal-login/userData.json"
elif [ -f "$HOME/rl-swarm/modal-login/temp-data/userData.json" ]; then
  cp "$HOME/rl-swarm/modal-login/temp-data/userData.json" "$TMP_USER_FILES/userData.json" && echo "âœ… å·²å¤‡ä»½ rl-swarm/modal-login/temp-data/userData.json"
else
  echo "âš ï¸ æœªæ£€æµ‹åˆ° userData.jsonï¼Œå¦‚æœ‰éœ€è¦è¯·æ‰‹åŠ¨è¡¥é½ã€‚"
fi

# ---------- Clone Repo ----------
if [[ -d "rl-swarm" ]]; then
  echo "âš ï¸ æ£€æµ‹åˆ°å·²å­˜åœ¨ç›®å½• 'rl-swarm'ã€‚"
  read -rp "æ˜¯å¦è¦†ç›–ï¼ˆåˆ é™¤åé‡æ–°å…‹éš†ï¼‰è¯¥ç›®å½•ï¼Ÿ(y/n): " confirm
  if [[ "$confirm" =~ ^[Yy]$ ]]; then
    echo "ğŸ—‘ï¸ æ­£åœ¨åˆ é™¤æ—§ç›®å½•..."
    rm -rf rl-swarm
    echo "ğŸ“¥ æ­£åœ¨å…‹éš† rl-swarm ä»“åº“ (v0.5.8.1 åˆ†æ”¯)..."
    git clone -b v0.5.8.1 https://github.com/readyName/rl-swarm.git
  else
    echo "âŒ è·³è¿‡å…‹éš†ï¼Œç»§ç»­åç»­æµç¨‹ã€‚"
  fi
else
  echo "ğŸ“¥ æ­£åœ¨å…‹éš† rl-swarm ä»“åº“ (v0.5.8.1 åˆ†æ”¯)..."
  git clone -b v0.5.8.1 https://github.com/readyName/rl-swarm.git
fi

# ---------- å¤åˆ¶ä¸´æ—¶ç›®å½•ä¸­çš„ user å…³é”®æ–‡ä»¶ ----------
KEY_DST="rl-swarm/swarm.pem"
MODAL_DST="rl-swarm/modal-login/temp-data"
mkdir -p "$MODAL_DST"

if [ -f "$TMP_USER_FILES/swarm.pem" ]; then
  cp "$TMP_USER_FILES/swarm.pem" "$KEY_DST" && echo "âœ… æ¢å¤ swarm.pem åˆ°æ–°ç›®å½•" || echo "âš ï¸ æ¢å¤ swarm.pem å¤±è´¥"
else
  echo "âš ï¸ ä¸´æ—¶ç›®å½•ç¼ºå°‘ swarm.pemï¼Œå¦‚æœ‰éœ€è¦è¯·æ‰‹åŠ¨è¡¥é½ã€‚"
fi

for fname in userApiKey.json userData.json; do
  if [ -f "$TMP_USER_FILES/$fname" ]; then
    cp "$TMP_USER_FILES/$fname" "$MODAL_DST/$fname" && echo "âœ… æ¢å¤ $fname åˆ°æ–°ç›®å½•" || echo "âš ï¸ æ¢å¤ $fname å¤±è´¥"
  else
    echo "âš ï¸ ä¸´æ—¶ç›®å½•ç¼ºå°‘ $fnameï¼Œå¦‚æœ‰éœ€è¦è¯·æ‰‹åŠ¨è¡¥é½ã€‚"
  fi
done

# ---------- ç”Ÿæˆæ¡Œé¢å¯åŒå‡»è¿è¡Œçš„ .command æ–‡ä»¶ï¼ˆmacOSï¼‰ ----------
if [[ "$OS_TYPE" == "macos" ]]; then
  CURRENT_USER="$(whoami)"
  PROJECT_DIR="/Users/$CURRENT_USER/rl-swarm"
  DESKTOP_DIR="/Users/$CURRENT_USER/Desktop"
  mkdir -p "$DESKTOP_DIR"

  echo "ğŸ” æƒé™çº§åˆ«ï¼š$GENSYN_PERMISSION"
  if [[ "$GENSYN_PERMISSION" == "full" ]]; then
    TARGETS=(gensyn.sh nexus.sh ritual.sh startAll.sh)
  elif [[ "$GENSYN_PERMISSION" == "gensyn_only" ]]; then
    TARGETS=(gensyn.sh)
  else
    echo "âŒ æœªçŸ¥æƒé™çº§åˆ«ï¼š$GENSYN_PERMISSION"
    TARGETS=()
  fi

  for script in "${TARGETS[@]}"; do
    cmd_name="${script%.sh}.command"
    cat > "$DESKTOP_DIR/$cmd_name" <<EOF
#!/bin/bash
set -e
trap 'echo -e "\n\033[33mâš ï¸ è„šæœ¬è¢«ä¸­æ–­ï¼Œä½†ç»ˆç«¯å°†ç»§ç»­è¿è¡Œ...\033[0m"; exit 0' INT TERM
cd "$PROJECT_DIR" || { echo "âŒ æ— æ³•è¿›å…¥é¡¹ç›®ç›®å½•"; exit 1; }
echo "ğŸš€ æ­£åœ¨æ‰§è¡Œ $script..."
./$script
echo -e "\n\033[32mâœ… $script æ‰§è¡Œå®Œæˆ\033[0m"
echo "æŒ‰ä»»æ„é”®å…³é—­æ­¤çª—å£..."
read -n 1 -s
EOF
    chmod +x "$DESKTOP_DIR/$cmd_name"
  done

  # dria.commandï¼ˆä»…åœ¨ full æƒé™æ—¶ç”Ÿæˆæ›´åˆç†ï¼‰
  if [[ "$GENSYN_PERMISSION" == "full" ]]; then
    cat > "$DESKTOP_DIR/dria.command" <<'EOF'
#!/bin/bash
set -e
trap 'echo -e "\n\033[33mâš ï¸ è„šæœ¬è¢«ä¸­æ–­ï¼Œä½†ç»ˆç«¯å°†ç»§ç»­è¿è¡Œ...\033[0m"; exit 0' INT TERM
echo "ğŸš€ æ­£åœ¨å¯åŠ¨ Dria Compute Launcher..."
dkn-compute-launcher start
echo -e "\n\033[32mâœ… Dria Compute Launcher æ‰§è¡Œå®Œæˆ\033[0m"
echo "æŒ‰ä»»æ„é”®å…³é—­æ­¤çª—å£..."
read -n 1 -s
EOF
    chmod +x "$DESKTOP_DIR/dria.command"
  fi

  # clean_spotlight.commandï¼ˆæ‰€æœ‰æƒé™çº§åˆ«éƒ½ç”Ÿæˆï¼‰
  cat > "$DESKTOP_DIR/clean_spotlight.command" <<EOF
#!/bin/bash
set -e
trap 'echo -e "\n\033[33mâš ï¸ è„šæœ¬è¢«ä¸­æ–­ï¼Œä½†ç»ˆç«¯å°†ç»§ç»­è¿è¡Œ...\033[0m"; exit 0' INT TERM
cd "$PROJECT_DIR" || { echo "âŒ æ— æ³•è¿›å…¥é¡¹ç›®ç›®å½•"; exit 1; }
echo "ğŸš€ æ­£åœ¨æ‰§è¡Œ clean_spotlight.sh..."
./clean_spotlight.sh
echo -e "\n\033[32mâœ… clean_spotlight.sh æ‰§è¡Œå®Œæˆ\033[0m"
echo "æŒ‰ä»»æ„é”®å…³é—­æ­¤çª—å£..."
read -n 1 -s
EOF
  chmod +x "$DESKTOP_DIR/clean_spotlight.command"

  echo "âœ… å·²åœ¨æ¡Œé¢ç”Ÿæˆå¯åŒå‡»è¿è¡Œçš„ .command æ–‡ä»¶ã€‚"
fi

# ---------- Clean Port 3000 ----------
echo "ğŸ§¹ Cleaning up port 3000..."
if command -v lsof &>/dev/null; then
  pid="$(lsof -ti:3000 || true)"
  if [[ -n "${pid:-}" ]]; then
    kill -9 "$pid" && echo "âœ… Killed: $pid" || echo "âš ï¸ ç»“æŸè¿›ç¨‹å¤±è´¥ï¼ˆPID: $pidï¼‰"
  else
    echo "âœ… Port 3000 is free."
  fi
else
  echo "âš ï¸ æœªæ‰¾åˆ° lsofï¼Œè·³è¿‡ç«¯å£æ¸…ç†ã€‚"
fi

# ---------- è¿›å…¥ rl-swarm å¹¶æ‰§è¡Œ ----------
cd rl-swarm || { echo "âŒ è¿›å…¥ rl-swarm ç›®å½•å¤±è´¥"; exit 1; }
chmod +x gensyn.sh
./gensyn.sh
